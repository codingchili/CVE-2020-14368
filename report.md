# CSWSH-THEIA-2020

- Report target: Eclipse CHE deployment available on che.openshift.io
- Vulnerability type: Cross-site websocket hijack
- Discovery date: 2020-04-08

# Description

This report concerns a cross-site websocket hijack in Theia IDE due to missing security constraints on the /service websocket endpoint. This vulnerability allows an attacker to access the workspace API's, which includes spawning a terminal in the container running the Theia IDE. To explit this vulnerability an attacker needs to know the endpoint to the Theia server, depending on deployment this might be as simple as `localhost` or a public domain. In the case of `che.openshift.io` the websocket endpoint is accessible through a randomly generated DNS ingress adress.

Read more about cross-site websocket hijacking here: https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking

This vulnerability cannot be reproduced in all deployments of Eclipse CHE as its dependent on the authentication mechanism. When using browser-based cookies for example with the SameSite cookie attribute properly configured, requests to establish a websocket from third-party domains will be unsuccessful (if cookie authentication is properly implemented for the deployment). The deployment on `che.openshift.io` uses cookies for authentication but does not set the SameSite attribute, which opens up for cross-site attacks.

Read more about the SameSite cookie attribute here: https://portswigger.net/web-security/csrf/samesite-cookies

# Scenario

1) plaintext DNS, still common. (not sure if other means are available)
2) MITM to inject javascript in plain HTTP connections for example.

(router ingress URL)

# Proof of concept

1) deploy the attached proof of concept on a third-party domain, locally (python -m http.server) or just open the .html file. 
2) browse to che.openshift.io authenticate, and open a workspace in eclipse CHE.

The PoC is interactive and will gain shell access over the /services websocket.

Retrieve the websocket domain for the /services endpoint and type "/connect <domain>" in the PoC.
I'm not sure if there's an easy way for an attacker to determine the ingress router address.

The domain can be retrieved using developer tools in chrome, started before loading the theia workspace or pressing F5, check the "Network" tab then filter on websockets to find the one connecting to /services and copy the domain name and paste into the exploit. The domain will look similar to "routecoobb1ln-<username>-che.b542.<region>.openshiftapps.com".

When the websocket is connected it'll print the message "use /attach to attach to a terminal", type "/attach maven" or use the dynamic theia-ide* in the exploit to attach the terminal to a container. If successful you'll see the message "terminal attached successfully" and "bash-4.4 /projects $", type "ls -l" or any other unix command to have it run in the server workspace.

Make sure that the third-party domain hosting the exploit code doesn't enable any x-site security features which could block the websocket connection. Sometimes it takes a few seconds for the websocket to connect. The PoC is tested in Google Chrome. 


1) basic walktrough
2) source code in addendum + how to host

# Screenshots

# Summary




